<!DOCTYPE html>  <html> <head>   <title>mediator.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="rocco.css" /> </head> <body> <div id="navbar">     <h3>Mediator.js - A light utility class to help implement the Mediator pattern<em></em></h3>   </div>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               mediator.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*!</span>
<span class="cm">* Mediator.js Library v0.6.0</span>
<span class="cm">* https://github.com/ajacksified/Mediator.js</span>
<span class="cm">*</span>
<span class="cm">* Copyright 2011, Jack Lawson</span>
<span class="cm">* MIT Licensed (http://www.opensource.org/licenses/mit-license.php)</span>
<span class="cm">*</span>
<span class="cm">* For more information: http://www.thejacklawson.com/index.php/2011/06/mediators-for-modularized-asynchronous-programming-in-javascript/</span>
<span class="cm">* Project on GitHub: https://github.com/ajacksified/Mediator.js</span>
<span class="cm">*</span>
<span class="cm">* Last update: Sep 15 2011</span>
<span class="cm">*/</span>

<span class="p">(</span><span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>We'll generate guids for class instances for easy referencing later on.
Subscriber instances will have an id that can be refernced for quick
lookups.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">guidGenerator</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">S4</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
       <span class="k">return</span> <span class="p">(((</span><span class="mi">1</span><span class="o">+</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">())</span><span class="o">*</span><span class="mh">0x10000</span><span class="p">)</span><span class="o">|</span><span class="mi">0</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">S4</span><span class="p">()</span><span class="o">+</span><span class="nx">S4</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nx">S4</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nx">S4</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nx">S4</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nx">S4</span><span class="p">()</span><span class="o">+</span><span class="nx">S4</span><span class="p">()</span><span class="o">+</span><span class="nx">S4</span><span class="p">());</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Subscribers are instances of Mediator Channel registrations. We generate
an object instance so that it can be updated later on without having to
unregister and re-register. Subscribers are constructed with a function
to be called, options object, and context.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">Subscriber</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Subscriber</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Subscriber</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">guidGenerator</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fn</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Subscriber</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Mediator.Update on a subscriber instance can update its function,context,
or options object. It takes in an object and looks for fn, context, or
options keys.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fn</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">fn</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">fn</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">context</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">options</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">channel</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">priority</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">SetPriority</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">priority</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>


  <span class="kd">function</span> <span class="nx">Channel</span><span class="p">(</span><span class="nx">namespace</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Channel</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Channel</span><span class="p">(</span><span class="nx">namespace</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">=</span> <span class="nx">namespace</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stopped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>A Mediator channel holds a list of sub-channels and callbacks to be fired
when Mediator.Publish is called on the Mediator instance. It also contains
some methods to manipulate its lists of data; only SetPriority and
StopPropagation are meant to be used. The other methods should be accessed
through the Mediator instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Channel</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">AddSubscriber</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subscriber</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">priority</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">priority</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">priority</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">priority</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">priority</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">priority</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">priority</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">callback</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

      <span class="k">return</span> <span class="nx">callback</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>The channel instance is passed as an argument to the mediator callback,
and further callback propagation can be called with
channel.StopPropagation().</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">StopPropagation</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stopped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">GetSubscriber</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">identifier</span><span class="p">){</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">y</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">identifier</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">fn</span> <span class="o">==</span> <span class="nx">identifier</span><span class="p">){</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">x</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">z</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">z</span><span class="p">)){</span>
          <span class="kd">var</span> <span class="nx">sub</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">[</span><span class="nx">z</span><span class="p">].</span><span class="nx">GetSubscriber</span><span class="p">(</span><span class="nx">identifier</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">sub</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">sub</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Channel.SetPriority is useful in updating the order in which Subscribers
are called, and takes an identifier (Callback id or named function) and
an array index. It will not search recursively through subchannels.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">SetPriority</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">identifier</span><span class="p">,</span> <span class="nx">priority</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">oldIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">y</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">identifier</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">fn</span> <span class="o">==</span> <span class="nx">identifier</span><span class="p">){</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">oldIndex</span> <span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">sub</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">oldIndex</span><span class="p">],</span>
          <span class="nx">firstHalf</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">oldIndex</span><span class="p">),</span>
          <span class="nx">lastHalf</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">oldIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">=</span> <span class="nx">firstHalf</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">lastHalf</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">priority</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">sub</span><span class="p">);</span>

    <span class="p">},</span>

    <span class="nx">AddChannel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channel</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Channel</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">channel</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">HasChannel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channel</span><span class="p">){</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">channel</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">ReturnChannel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channel</span><span class="p">){</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">];</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>This will remove a subscriber recursively through its subchannels.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">RemoveSubscriber</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">identifier</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">identifier</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">z</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">z</span><span class="p">)){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">[</span><span class="nx">z</span><span class="p">].</span><span class="nx">RemoveSubscriber</span><span class="p">(</span><span class="nx">identifier</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">x</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">y</span><span class="p">].</span><span class="nx">fn</span> <span class="o">==</span> <span class="nx">identifier</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">y</span><span class="p">].</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">identifier</span><span class="p">){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">y</span><span class="p">].</span><span class="nx">channel</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
          <span class="nx">x</span><span class="o">--</span><span class="p">;</span> <span class="nx">y</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>This will publish arbitrary arguments to a subscriber recursively
through its subchannels.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Publish</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">x</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stopped</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">y</span><span class="p">],</span> <span class="nx">l</span><span class="p">;</span>

          <span class="k">if</span><span class="p">(</span><span class="nx">callback</span><span class="p">.</span><span class="nx">options</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">predicate</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">callback</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">predicate</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">callback</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span> <span class="nx">data</span><span class="p">)){</span>
              <span class="nx">callback</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">callback</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">callback</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">callback</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">l</span> <span class="o">&lt;</span> <span class="nx">x</span><span class="p">)</span> <span class="nx">y</span><span class="o">--</span><span class="p">;</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">l</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stopped</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">x</span><span class="p">)){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">Publish</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">stopped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">Mediator</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Mediator</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Mediator</span><span class="p">();</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Channel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>A Mediator instance is the interface through which events are registered
and removed from publish channels.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Mediator</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Returns a channel instance based on namespace, for example
application:chat:message:received</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">GetChannel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">namespace</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">namespaceHierarchy</span> <span class="o">=</span> <span class="nx">namespace</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">namespace</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">channel</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">namespaceHierarchy</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">namespaceHierarchy</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">j</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>

          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">channel</span><span class="p">.</span><span class="nx">HasChannel</span><span class="p">(</span><span class="nx">namespaceHierarchy</span><span class="p">[</span><span class="nx">i</span><span class="p">])){</span>
            <span class="nx">channel</span><span class="p">.</span><span class="nx">AddChannel</span><span class="p">(</span><span class="nx">namespaceHierarchy</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
          <span class="p">}</span>

          <span class="nx">channel</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">ReturnChannel</span><span class="p">(</span><span class="nx">namespaceHierarchy</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">channel</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Pass in a channel namespace, function to be called, options, and context
to call the function in to Subscribe. It will create a channel if one
does not exist. Options can include a predicate to determine if it
should be called (based on the data published to it) and a priority
index.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Subscribe</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channelName</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">context</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{},</span>
          <span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">||</span> <span class="p">{},</span>
          <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">GetChannel</span><span class="p">(</span><span class="nx">channelName</span><span class="p">),</span>
          <span class="nx">sub</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">AddSubscriber</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>

      <span class="k">return</span> <span class="nx">sub</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Returns a subscriber for a given subscriber id / named function and
channel namespace</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">GetSubscriber</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">identifier</span><span class="p">,</span> <span class="nx">channel</span><span class="p">){</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">GetChannel</span><span class="p">(</span><span class="nx">channel</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">GetSubscriber</span><span class="p">(</span><span class="nx">identifier</span><span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Remove a subscriber from a given channel namespace recursively based on
a passed-in subscriber id or named function.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channelName</span><span class="p">,</span> <span class="nx">identifier</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">GetChannel</span><span class="p">(</span><span class="nx">channelName</span><span class="p">).</span><span class="nx">RemoveSubscriber</span><span class="p">(</span><span class="nx">identifier</span><span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Publishes arbitrary data to a given channel namespace. Channels are
called recursively downwards; a post to application:chat will post to
application:chat:receive and application:chat:derp:test:beta:bananas.
Called using Mediator.Publish("application:chat", [ args ]);</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Publish</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channelName</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
          <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">GetChannel</span><span class="p">(</span><span class="nx">channelName</span><span class="p">);</span>

      <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">channel</span><span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">GetChannel</span><span class="p">(</span><span class="nx">channelName</span><span class="p">).</span><span class="nx">Publish</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Finally, expose it all.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nb">window</span><span class="p">.</span><span class="nx">Mediator</span> <span class="o">=</span> <span class="nx">Mediator</span><span class="p">;</span>
  <span class="nx">Mediator</span><span class="p">.</span><span class="nx">Channel</span> <span class="o">=</span> <span class="nx">Channel</span><span class="p">;</span>
  <span class="nx">Mediator</span><span class="p">.</span><span class="nx">Subscriber</span> <span class="o">=</span> <span class="nx">Subscriber</span><span class="p">;</span>
<span class="p">})(</span><span class="nb">window</span><span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 